# Модуль OAuth авторизации

При авторизации в BILLmanager используется Authorization Code Flow из OAuth 2.0

Основные шаги Authorization Code Flow
- Пользователь производит авторизацию или регистрацию в BILLmanager через OAuth сервис
- BILLmanager перенаправляет пользователя на страницу авторизации стороннего сервиса
- Пользователь производит авторизацию в стороннем сервисе
- Сторонний сервис перенаправляет пользователя в BILLmanager с временным кодом
- BILLmanager использует временный код для получения данных пользователя из стороннего сервиса

## Стркутура модуля

1. С++ плагин, где регистрируется наследник `project::MethodOAuth`.
Конструктор `project::MethodOAuth` принимает intname метода авторизации.
Базовый плагин состоит из
- cpp файлов, которые собираются в динамическую библиотеку
- xml файла, где подключается библиотека и определяются сообщения для нового метода авторизации

```
src/oauth_yandex.cpp
xml/billmgr_mod_yandex.xml
```

2. Скрипт на python, который реализует две команды
 - `make_url` - формирует url, куда необходимо перенаправить клиента при авторизации через новый метода
 - `get_user_data` - формирует информацию о пользователе, которую получает на основе временного кода.
Обязательные параметры пользователя, которые ожидает BILLmanager: firstname, lastname, realname, email, id (из внешней системы)

Важно, скрипт должен начинаться с `om` остальная часть должна совпадать с intname метода авторизации
При установке `.py` опускается
```
oauth/omyandex.py
```

3. Иконки для метода авторизации, в качестве имени используется intname метода авторизации
```
dist/skins/common/img/yandex.svg
dist/skins/dragon/default/yandex.svg
```

## Пример Модуля

### Настройка

В качестве примера реализована авторизация через Яндекс ID
https://yandex.ru/dev/id/doc/ru/codes/code-url

При регистрации приложения необходимо
- указать тип приложения `Веб-сервисы`
- указать Redirect URI
```
https://domain.com/billmgr?func=oauth.save.userdata&network=yandex
```
- запросить права к
    - доступ к адресу электронной почты
    - доступ к логину, имени и фамилии, полу

После регистрации приложения в скрипте `oauth/omyandex.py` нужно указать полученные CLIENT_ID и CLIENT_SECRET

### Сборка и установка

1. Необходимо установить dev пакеты
    deb-based OS:`apt install coremanager-dev billmanager-dev billmanager-plugin-python-libs`
    redhat-based: `yum install coremanager-dev billmanager-dev billmanager-plugin-python-libs`
2. Кладем проект модуля авторизации по пути `/usr/local/mgr5/src/`
3. Переходим в директорию проекта и выполняем установку дополнительных зависимостей для сборки
    deb-based OS:`make debian-prepare`
    redhat-based: `make centos-prepare`
4. Устанавливаем модуль `make install`

## Дополнительно

Для удобной разработки C++ плагинов можно сипользовать clangd
Это позволит ходить по зависимостям и использовать статический анализатор для нахождения ошибок
1. Устанавливаем `clangd`
2. Создаем `compile_commands.json` при помощи `./gen_compile_commands.py`
3. Используем любое расширение для работы с clangd в вашей IDE