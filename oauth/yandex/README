# Модуль OAuth авторизации

При авторизации в BILLmanager используется Authorization Code Flow из OAuth 2.0

Основные шаги Authorization Code Flow
- Пользователь производит авторизацию или регистрацию в BILLmanager через OAuth сервис
- BILLmanager перенаправляет пользователя на страницу авторизации стороннего сервиса
- Пользователь производит авторизацию в стороннем сервисе
- Сторонний сервис перенаправляет пользователя в BILLmanager с временным кодом
- BILLmanager использует временный код для получения данных пользователя из стороннего сервиса

## Стркутура модуля

1. XML с описанием плагина метадатой и сообщениями для метода авторизации `xml/billmgr_mod_omyandex.xml`.
Секция `plugin` содержит внутреннее наименование метода авторизации, а также группу плагина - `oauth`
на основе этой секции происходит регистрация метода авторизации
```
  <plugin name="yandex">
    <group>oauth</group>
  </plugin>
```
Метадата в XML соджержит
- Поля для настройки метода авторизации на форме провайдера
```
  <metadata name="project.edit" type="form" mgr="billmgr">
    <form>
      <page name="auth">
        <field name="auth_method_yandex" after="custom_methods">
          <input type="toggle" name="auth_method_yandex"/>
        </field>
      </page>
    </form>
  </metadata>
```
- Поля для натсрйоки метода авторизации на форме параметров пользователя
```
  <metadata name="usrparam" type="form">
    <form>
      <page name="socnetwork">
        <field name="yandex_status">
          <input type="checkbox" name="yandex_status">
            <if value="on" hide="yandex_signup"/>
            <if value="off" hide="yandex_status"/>
          </input>
        </field>
        <field name="yandex_signup">
          <link name="yandex_signup_link" target="_self" referrer="yes"/>
        </field>
      </page>
    </form>
  </metadata>
```

2. Скрипт на python `oauth/omyandex.py`, который реализует две команды
 - `make_url` - формирует url, куда необходимо перенаправить клиента при авторизации через новый метода
 - `get_user_data` - формирует информацию о пользователе, которую получает на основе временного кода
Обязательные параметры пользователя, которые ожидает BILLmanager: firstname, lastname, realname, email, id (из внешней системы). 
Важно, скрипт должен начинаться с `om` остальная часть должна совпадать с внутренним наименованием метода авторизации в XML
При установке `.py` опускается. 

3. Иконки для метода авторизации, в качестве имени используется внутреннее наименование метода авторизации в XML
```
dist/skins/common/img/yandex.svg
dist/skins/dragon/default/yandex.svg
```

## Пример Модуля

### Настройка

В качестве примера реализована авторизация через Яндекс ID
https://yandex.ru/dev/id/doc/ru/codes/code-url

При регистрации приложения необходимо
- указать тип приложения `Веб-сервисы`
- указать Redirect URI
```
https://domain.com/billmgr?func=oauth.save.userdata&network=yandex
```
- запросить права к
    - доступ к адресу электронной почты
    - доступ к логину, имени и фамилии, полу

После регистрации приложения в скрипте `oauth/omyandex.py` нужно указать полученные CLIENT_ID и CLIENT_SECRET

### Сборка и установка

1. Необходимо установить dev пакеты
    deb-based OS:`apt install coremanager-dev billmanager-dev billmanager-plugin-python-libs`
    redhat-based: `yum install coremanager-dev billmanager-dev billmanager-plugin-python-libs`
2. Кладем проект модуля авторизации по пути `/usr/local/mgr5/src/`
3. Переходим в директорию проекта и выполняем установку дополнительных зависимостей для сборки
    deb-based OS:`make debian-prepare`
    redhat-based: `make centos-prepare`
4. Устанавливаем модуль `make install`
